name: Discord News Publisher

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Discord payload
        run: |
          TITLE=$(jq -r '.columns.left[] | select(.major==true) | .title' data.json)
          SUBHEAD=$(jq -r '.columns.left[] | select(.major==true) | .subhead // ""' data.json)
          IMAGE=$(jq -r '.columns.left[] | select(.major==true) | .image.src // ""' data.json)
          SITE="https://drivesave01plm-gif.github.io/Traumatic-News/"

          jq -n \
          --arg title "$TITLE" \
          --arg desc "$SUBHEAD" \
          --arg img "$IMAGE" \
          --arg site "$SITE" \
          '{
            content: "<@&ROLE_ID> ðŸ“° **NEW ISSUE RELEASED**",
            embeds: [
              {
                title: $title,
                url: $site,
                description: $desc,
                color: 9127187,
                image: { url: $img },
                footer: {
                  text: "Traumatic News â€¢ Auto published"
                }
              }
            ]
          }' > payload.json

      - name: Send to Discord (create thread)
        run: |
          curl -X POST "$DISCORD_WEBHOOK?wait=true" \
            -H "Content-Type: application/json" \
            --data @payload.json \
          | jq -r '.id' > message_id.txt

          MSG_ID=$(cat message_id.txt)

          curl -X POST "$DISCORD_WEBHOOK/threads" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"ðŸ“° $TITLE\",\"message_id\":\"$MSG_ID\"}"
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ROLE_ID: ${{ secrets.DISCORD_ROLE_ID }}
